---
title: "React Ã— Laravelã§React Queryã®ç·´ç¿’ãŒã¦ã‚‰ã€ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ãŸ"
description: "React Queryã‚’ä½¿ã£ãŸãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’å®Ÿè£…ã—ãŸä¾‹"
pubDate: "2021-03-21"
updatedDate: "2023-07-09"
category: "develop"
tags: ["TypeScript", "React", "React Query", "PHP", "Laravel"]
---

React ã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨è¨€ã†ã¨ Redux ã‚„ Recoil ãŒãƒ¡ã‚¸ãƒ£ãƒ¼ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã—ã‚‡ã†ã‹ã€‚
å°‘ã—å‰ã‹ã‚‰ React Query ãªã‚‹ã‚‚ã®ãŒä¾¿åˆ©ã‚‰ã—ã„ãã¨è¦‹èãã—ãŸã®ã§ä½¿ã£ã¦ã¿ãŸã®ã‚’ã€ã›ã£ã‹ããªã®ã§è¨˜äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

import ImageWrapper from "@/components/ImageWrapper.astro"
import OG from "@/components/OG.astro"

â€»2023/07/09 å„ç¨®ãƒªãƒ³ã‚¯ã® URL ã‚’ tanstack.com ã‚’ãƒ™ãƒ¼ã‚¹ã«æ›´æ–°ã—ã¾ã—ãŸã€‚

## React Query ã¨ã¯ï¼Ÿ
<OG url="https://tanstack.com/query/v3" />

ã‚‚ã®ã™ã”ãã–ã£ãã‚Šã„ã†ã¨ã€React ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€æ›´æ–°ã€‚ãã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¾ã§ä¸€æ°—ã«ã‚„ã£ã¦ãã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã„ã£ãŸæ„Ÿã˜ã§ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„æ›´æ–°ã®æ–¹æ³•ã¯ã“ã¡ã‚‰ã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ Promise ã§è¿”ã™é–¢æ•°ãªã‚‰ä½•ã§ã‚‚ä½¿ãˆã¾ã™ã€‚
ãªã®ã§ã€fetch ã§ã‚‚ ky ã§ã‚‚ axios ã§ã‚‚ OKã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã¦ãŠã‚Šã€å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯æŒ‡å®šã—ãŸã‚¯ã‚¨ãƒªã‚­ãƒ¼ã¨ç´ã¥ã‘ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚
ã“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ã©ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æ™‚é–“ãŒéãã‚‹ã¨ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã®å†å–å¾—ãŒè‡ªå‹•ã§è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ï¼ˆãã®åˆ†ã€API ãƒªã‚¯ã‚¨ã‚¹ãƒˆç­‰ãŒå¢—ãˆã‚‹ã¨ã„ã†ã“ã¨ã§ã‚‚ã‚ã‚‹ã®ã§ã€å°å…¥ã™ã‚‹ã‚¢ãƒ—ãƒªã«å¿œã˜ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§èª¿æ•´ã—ãŸæ–¹ãŒã„ã„ã§ã™ï¼‰

ãã‚Œã¨å€‹äººçš„ã«ç‰¹ã«ã„ã„ãªã¨æ€ã£ãŸéƒ¨åˆ†ã¨ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã€æ›´æ–°ã®çŠ¶æ…‹ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ãªã®ã‹ã€æˆåŠŸã—ãŸã®ã‹ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã®ã‹ã¨ã„ã£ãŸã‚ãŸã‚Šã€‚
ã“ã®çŠ¶æ…‹ã‚’ä½¿ã£ã¦ã€èª­ã¿è¾¼ã¿ä¸­ã‚„ã‚¨ãƒ©ãƒ¼ã®æ™‚ã® UI ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã„ã†ã“ã¨ã‚‚ã€æ¥½ã«ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### ä½¿ç”¨ä¾‹
React Query ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€ã¾ãšæœ€åˆã«`QueryClient`ã‚’ä½œæˆã€‚
ã‚¢ãƒ—ãƒªã‚’`QueryClientProvider`ã§å›²ã¿ã€ãã“ã«ä½œæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§ã€ã“ã®é…ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ React Query ã®æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

React Query ãŒæä¾›ã™ã‚‹ãƒ•ãƒƒã‚¯ã¯ã„ã‚ã„ã‚ã‚ã‚‹ã®ã§ã™ãŒã€åŸºæœ¬ã¨ãªã‚‹ã‚‚ã®ã¨ã—ã¦ã¯ä»¥ä¸‹ã®2ã¤ã§ã™ã€‚
- ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼šuseQuery
- ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼šuseMutation

### useQuery
<OG url="https://tanstack.com/query/v3/docs/react/reference/useQuery" />

å…¬å¼ã®ä¾‹
<OG url="https://codesandbox.io/s/github/tanstack/query/tree/v3/examples/simple" />

```jsx
/* eslint-disable jsx-a11y/anchor-is-valid */
import React from "react";
import ReactDOM from "react-dom";
import { QueryClient, QueryClientProvider, useQuery } from "react-query";
import { ReactQueryDevtools } from "react-query/devtools";

const queryClient = new QueryClient();

export default function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <Example />
    </QueryClientProvider>
  );
}

function Example() {
  const { isLoading, error, data, isFetching } = useQuery("repoData", () =>
    fetch(
      "https://api.github.com/repos/tannerlinsley/react-query"
    ).then((res) => res.json())
  );

  if (isLoading) return "Loading...";

  if (error) return "An error has occurred: " + error.message;

  return (
    <div>
      <h1>{data.name}</h1>
      <p>{data.description}</p>
      <strong>ğŸ‘€ {data.subscribers_count}</strong>{" "}
      <strong>âœ¨ {data.stargazers_count}</strong>{" "}
      <strong>ğŸ´ {data.forks_count}</strong>
      <div>{isFetching ? "Updating..." : ""}</div>
      <ReactQueryDevtools initialIsOpen />
    </div>
  );
}

const rootElement = document.getElementById("root");
ReactDOM.render(<App />, rootElement);
```
`useQuery`ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚
- ç¬¬1å¼•æ•°ï¼šã‚¯ã‚¨ãƒªã‚­ãƒ¼
- ç¬¬2å¼•æ•°ï¼šãƒ‡ãƒ¼ã‚¿å–å¾—ã®é–¢æ•°

ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã«ã¯é…åˆ—ã®æŒ‡å®šã‚‚ã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å–å¾—ã®é–¢æ•°ã«ã‚ˆã‚Šå–å¾—ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ã“ã®ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã¨ç´ã¥ã‘ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚
ã¾ãŸã€ç¬¬3å¼•æ•°ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã—ã¦ã€æˆåŠŸæ™‚ã‚„å¤±æ•—æ™‚ã®å‡¦ç†ã‚’æ›¸ã„ãŸã‚Šã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ãŸã‚Šã—ã¾ã™ã€‚

### useMutation
<OG url="https://tanstack.com/query/v3/docs/react/reference/useMutation" />

å…¬å¼ã®ä¾‹ï¼ˆ`useQuery`ã¨`useMutation`ï¼‰ã€€â€»2023/07/09æ™‚ç‚¹ã§ã¯ TypeScript ã«ãªã£ã¦ã„ã¾ã—ãŸ
<OG url="https://codesandbox.io/p/sandbox/github/tanstack/query/tree/v3/examples/optimistic-updates-typescript" />
```jsx
import React from 'react'
import axios from 'axios'
import {
  useQuery,
  useQueryClient,
  useMutation,
  QueryClient,
  QueryClientProvider,
} from 'react-query'
import { ReactQueryDevtools } from 'react-query/devtools'

const queryClient = new QueryClient()

export default function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <Example />
    </QueryClientProvider>
  )
}

function Example() {
  const queryClient = useQueryClient()
  const [text, setText] = React.useState('')
  const { status, data, error, isFetching } = useQuery('todos', async () => {
    const res = await axios.get('/api/data')
    return res.data
  })

const addTodoMutation = useMutation(
    text => axios.post('/api/data', { text }),
    {
      // Optimistically update the cache value on mutate, but store
      // the old value and return it so that it's accessible in case of
      // an error
      onMutate: async text => {
        setText('')
        await queryClient.cancelQueries('todos')
        const previousValue = queryClient.getQueryData('todos')
        queryClient.setQueryData('todos', old => ({
          ...old,
          items: [...old.items, text],
        }))
        return previousValue
      },
      // On failure, roll back to the previous value
      onError: (err, variables, previousValue) =>
        queryClient.setQueryData('todos', previousValue),
      // After success or failure, refetch the todos query
      onSuccess: () => {
        queryClient.invalidateQueries('todos')
      },
    }
  )

  return (
    <div>
      <p>
        In this example, new items can be created using a mutation. The new item
        will be optimistically added to the list in hopes that the server
        accepts the item. If it does, the list is refetched with the true items
        from the list. Every now and then, the mutation may fail though. When
        that happens, the previous list of items is restored and the list is
        again refetched from the server.
      </p>
      <form
        onSubmit={e => {
          e.preventDefault()
          addTodoMutation.mutate(text)
        }}
      >
        <input
          type="text"
          onChange={event => setText(event.target.value)}
          value={text}
        />
        <button>{addTodoMutation.isLoading ? 'Creating...' : 'Create'}</button>
      </form>
      <br />
      {status === 'loading' ? (
        'Loading...'
      ) : status === 'error' ? (
        error.message
      ) : (
        <>
          <div>Updated At: {new Date(data.ts).toLocaleTimeString()}</div>
          <ul>
            {data.items.map(datum => (
              <li key={datum}>{datum}</li>
            ))}
          </ul>
          <div>{isFetching ? 'Updating in background...' : ' '}</div>
        </>
      )}
      <ReactQueryDevtools initialIsOpen />
    </div>
  )
}
```

`useMutation`ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚
- ç¬¬1å¼•æ•°ï¼šãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®é–¢æ•°
- ç¬¬2å¼•æ•°ï¼šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

ã“ã®ç¬¬1å¼•æ•°ã«æŒ‡å®šã—ãŸé–¢æ•°ã¯ã€`useMutation`ãŒå‘¼ã°ã‚ŒãŸã ã‘ã§ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚
`useMutation`ã®è¿”ã‚Šå€¤ã®ä¸­ã«ã€ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ï¼ˆmutateï¼‰ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãã‚Œã‚’ä½¿ã†ã“ã¨ã§åˆã‚ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ä¸Šè¨˜ã®ä¾‹ã ã¨`addTodoMutation.mutate(text)`ã®éƒ¨åˆ†ã§ã™ã€‚
ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã«æ¸¡ã—ãŸå¼•æ•°ãŒã€ãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®é–¢æ•°ã«æ¸¡ã•ã‚Œã¾ã™ã€‚

ä¸Šè¨˜ã®ä¾‹ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã•ã‚‰ã£ã¨èª¬æ˜ã™ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
- onMutateï¼šãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«ã€å…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ï¼ˆå‰å‡¦ç†ã‚’æ›¸ãï¼‰
- onErrorï¼šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
- onSuccessï¼šæˆåŠŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†

æˆåŠŸæ™‚ã€ã‚¨ãƒ©ãƒ¼æ™‚ã¨ã‚‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ onSettled ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€onSuccessã€onErrorã€onSettled ã«é–¢ã—ã¦ã¯ã€`useMutation`ã ã‘ã§ãªãã€ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã¨ã—ã¦ã‚‚æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
ã©ã¡ã‚‰ã«ã‚‚åŒåã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦ã„ã‚‹å ´åˆã¯ã€`useMutation`ã«æ¸¡ã—ãŸæ–¹ãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

---

ã¡ãªã¿ã«`ReactQueryDevtools`ã¯é–‹ç™ºæ”¯æ´ã® DevTools ã§ã™ã€‚
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ãªã©ãŒã‚ã‹ã‚‹ã®ã§ã€ã„ã‚Œã¦ãŠãã¨ã‚ˆã„ã§ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚

## ä»Šå›ä½œã£ã¦ã¿ãŸã‚‚ã®
å‹‰å¼·ç”¨ã®å€‹äººé–‹ç™ºã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ä½œã‚Šã¾ã—ãŸã€‚
Reactï¼ˆLaravel Mixï¼‰Ã— Laravel ã«ã‚ˆã‚‹ SPA Ã— API æ§‹æˆã§ã™ã€‚

<ImageWrapper src="gifs/2021/laravel-react-query-auth/email-login.gif" alt="ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹æµã‚Œã®GIF" />

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãªã‚¿ã‚¤ãƒ—ã€‚
å¾Œã€…ã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚²ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã«ã—ãŸã„ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šã€ä»Šå›ãƒ¡ãƒ¼ãƒ«èªè¨¼ã¯ç‰¹ã«ã‚„ã£ã¦ã„ã¾ã›ã‚“ã€‚

ã¾ãŸã€API ã®èªè¨¼æ–¹å¼ã«ã¤ã„ã¦ã¯ Cookie ã‚’ä½¿ã£ãŸã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

å®Ÿè£…ã«ã‚ãŸã£ã¦ã„ã‚ã‚“ãªæ–‡çŒ®ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã®ã§ã™ãŒã€ä»¥ä¸‹ã®2ã¤ã¯ç‰¹ã«ãŠä¸–è©±ã«ãªã‚Šã¾ã—ãŸã€‚

â€»é€£è¼‰è¨˜äº‹
<OG url="https://www.hypertextcandy.com/vue-laravel-tutorial-introduction" />
â€»æ›¸ç±
<OG url="https://github.com/oukayuka/Riakuto-StartingReact-ja3.1" />

ãã‚Œã¨å„ç¨®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã€‚

## å‰æ
ä»Šå›ä½¿ç”¨ã—ãŸå„ç¨®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

åŸºæœ¬éƒ¨åˆ†.
- Node.jsï¼š14.2.0
- TypeScriptï¼š4.1.3
- Reactï¼š16.14.0
- PHPï¼š7.4.14
- Laravelï¼š6.20.9

ãƒ©ã‚¤ãƒ–ãƒ©ãƒª.
- Material UI
  - coreï¼š4.11.3
  - labï¼š4.0.0-alpha.57
- axiosï¼š0.21.1
- react-router-domï¼š5.2.0
- react-queryï¼š3.12.1

ä»¥ä¸‹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ã™ã§ã«ã™ã‚“ã§ã„ã‚‹ã‚‚ã®ã¨ã—ã¦é€²ã‚ã¾ã™ã€‚
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- Laravel UI ã§ React ã®å°å…¥
- TypeScript ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
Laravel å´ã¯ç‰¹ã«å¤‰ã‚ã£ãŸã“ã¨ã‚’ã—ã¦ãªã„ã®ã§ã€React å´ã ã‘è¨˜è¼‰ã—ã¾ã™ã€‚

Laravel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® resources/ts é…ä¸‹.
```
â”œ components
â”‚   â”œ molecules
â”‚   â”‚   â”” LoginAlert.tsx
â”‚   â”œ organisms
â”‚   â”‚   â”” Header.tsx
â”‚   â”œ pages
â”‚   â”‚   â”œ Loding.tsx
â”‚   â”‚   â”œ Login.tsx
â”‚   â”‚   â”” Memo.tsx
â”œ constants
â”‚   â”” statusCode.ts
â”œ containers
â”‚   â”œ organisms
â”‚   â”‚   â”” Header.tsx
â”‚   â”œ pages
â”‚   â”‚   â”œ Login.tsx
â”‚   â”‚   â”” Memo.tsx
â”œ hooks
â”‚   â”œ auth
â”‚   â”‚   â”œ index.ts
â”‚   â”‚   â”œ useLogin.ts
â”‚   â”‚   â”” useLogout.ts
â”‚   â”œ user
â”‚   â”‚   â”œ index.ts
â”‚   â”‚   â”œ useCurrentUser.ts
â”‚   â”‚   â”” useGetUserQuery.ts
â”œ models
â”‚   â”” User.ts
â”œ app.tsx
â”” bootstrap.js
```

ä»¥é™ã€ä»Šå›ã®å®Ÿè£…ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ãŒã€ã ã„ã¶é•·ããªã‚Šã¾ã—ãŸ...ğŸ™„
GitHub ã§è¦‹ãŸã„ã¨ã„ã†æ–¹ã¯ã€ã“ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¿ã‚°ã‚’ã¤ã‘ã¦ã‚ã‚Šã¾ã™ã€‚
<OG url="https://github.com/h-yoshikawa44/ooui-memo/releases/tag/post%2Flaravel-react-query-auth" />

â€»2021/09/13è¿½è¨˜ é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‹å®šç¾©ã« FC ã°ã£ã‹ã‚Šä½¿ã£ã¦ã¾ã™ãŒã€FC ã‹ã‚‰ children ãŒãªããªã‚‹ã¾ã§ã¯ VFC ã‚’ä½¿ã£ãŸæ–¹ãŒã„ã„ã§ã™...ã€‚

## APIï¼ˆLaravelï¼‰å´
â€»ä»Šå›ã€ãƒ¦ãƒ¼ã‚¶æ–°è¦ç™»éŒ²ã®éƒ¨åˆ†ã¯è¨˜è¼‰ã—ã¦ã„ã¾ã›ã‚“ã€‚
Laravel ã«å…ƒã€…å‚™ã‚ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’ä½¿ã£ã¦ API ã‚’ä½œã‚‹ãªã‚Šã€tinker ã§ãƒ¦ãƒ¼ã‚¶ã‚’ä½œã£ã¦ãŠããªã‚Šã§ã”å¯¾å¿œãã ã•ã„ã€‚

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
ç”»é¢ã®æŒ¯ã‚Šåˆ†ã‘ã¯ React å´ã§è¡Œã†ã®ã§ã€Laravel å´ã§ã¯å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```php:routes/web.php
Route::get('/{any?}', fn() => view('index'))->where('any', '.+');
```

â€»2021/05/19 è¿½è¨˜
å…¨å—ã‘ã«ã™ã‚‹ã¨ã€API ãƒ«ãƒ¼ãƒˆã§ where åˆ¶ç´„ã‚’ã‹ã‘ãŸéš›ã«äºˆæœŸã—ãªã„å‹•ä½œã‚’å¼•ãèµ·ã“ã™ã®ã§ api ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯é™¤å¤–ã—ã¦ãŠã„ãŸæ–¹ãŒã„ã„ã§ã™ã€‚
ï¼ˆåˆ¶ç´„å¤–ã®ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã®ã¯ãšãªã®ã«ã€ã“ã®ãƒ«ãƒ¼ãƒˆã«æ¥ã¦200ã«ãªã£ã¦ã—ã¾ã†ã®ã§ï¼‰

```php:routes/web.php
Route::get('/{any?}', fn() => view('index'))->where('any', '(?!api).+');
```

### API ãƒ«ãƒ¼ãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´
ä»Šå›ã¯ Cookie ã‚’ä½¿ã£ãŸèªè¨¼ã«ã—ã¦ã„ãã¾ã™ã€‚
ä¸‹è¨˜ã®ã¨ãŠã‚Šã€ãã‚Œã«å¿…è¦ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ web ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

```php:app/Http/Kernel.php
protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        // \Illuminate\Session\Middleware\AuthenticateSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],

    'api' => [
        'throttle:60,1',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
];
```
ãã‚Œã‚’ API ã§ã‚‚ä½¿ã†ã‚ˆã†ã«æ€ã„åˆ‡ã£ã¦å¤‰ãˆã¾ã—ãŸã€‚

```php:app/Providers/RouteServiceProvider.php
    protected function mapApiRoutes()
    {
        // WebãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã®æ©Ÿèƒ½ã‚’ä½¿ã„ãŸã„ã®ã§webã¸
        Route::prefix('api')
             ->middleware('web')
             ->namespace($this->namespace)
             ->group(base_path('routes/api.php'));
    }
```
ãªã‚“ã‹æŠµæŠ—ãŒã‚ã‚‹ã¨ã„ã†å ´åˆã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãª API ç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ–°ãŸã«ä½œã£ã¦ã€ãã‚Œã‚’å‰²ã‚Šå½“ã¦ã‚‹ã®ã‚‚æ‰‹ã§ã™ã€‚

#### CSRF å¯¾ç­–ã«ã¤ã„ã¦
ã“ã® web ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¯ CSRF å¯¾ç­–ã®æ©Ÿèƒ½ã‚’æŒã¤ã€`\App\Http\Middleware\VerifyCsrfToken::class`ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
ãªã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®éš›ã«ã¯ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‰ãªã„ã¨ã¯ã˜ã‹ã‚Œã¾ã™ã€‚
<OG url="https://readouble.com/laravel/6.x/ja/csrf.html" />

ä»Šå›ã®å ´åˆã€SPA å´ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ axios ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«`X-XSRF-TOKEN`ã‚’ã¤ã‘ã¦é€ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãŸã ã€ã“ã®ã‚ãŸã‚Šã®è¨­å®šã«é–¢ã—ã¦ç‰¹ã«ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

`\App\Http\Middleware\VerifyCsrfToken::class`ã§ä»¥ä¸‹ã®è¨­å®šãŒã‚ã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã®`Set-Cookie`ã«`XSRF-TOKEN`ã‚’è¨­å®šã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚
```php
/**
 * Indicates whether the XSRF-TOKEN cookie should be set on the response.
 *
 * @var bool
 */
protected $addHttpCookie = true;
```
ãã—ã¦ã€axios ã¯ Cookie ã«`XSRF-TOKEN`ãŒã‚ã‚‹ã¨ã€è‡ªå‹•ã§`X-XSRF-TOKEN`ã«ã‚»ãƒƒãƒˆã—ã¦é€ã£ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

### ãƒ­ã‚°ã‚¤ãƒ³ API
Laravel ãŒå…ƒã€…å‚™ãˆã¦ã„ã‚‹æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã¦ä½¿ç”¨ã€‚

`LoginController`ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹`AuthenticatesUsers`ãƒˆãƒ¬ã‚¤ãƒˆã«èªè¨¼ã«é–¢ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã“ã«ãƒ­ã‚°ã‚¤ãƒ³ API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦`authenticated`ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’è¿”ã™ã‚ˆã†ã«ã€‚

```php:app/Http/Controllers/Auth/LoginController.php
/**
 * ãƒ­ã‚°ã‚¤ãƒ³API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ãƒ¡ã‚½ãƒƒãƒ‰
 *
 * @param Illuminate\Http\Request $request
 * @param \App\User $user
 * @return \App\User
 */
protected function authenticated(Request $request, $user)
{
    return $user;
}
```

API ã®ãƒ«ãƒ¼ãƒˆã«è¿½åŠ ã€‚

```php:routes/api.php
Route::post('/login', 'Auth\LoginController@login')->name('login');
```

### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ API
ãƒ­ã‚°ã‚¤ãƒ³ API ã¨åŒæ§˜ã«ä½œæˆã€‚

ã“ã¡ã‚‰ã¯`loggedOut`ãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ãªã‚Šã¾ã™ã€‚

â€»2021/04/13 è¿½è¨˜
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯`response(null, 204)`ã§204ã‚’è¿”ã—ãŸæ–¹ãŒã„ã„ã‚„ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
â€»2021/04/27 è¿½è¨˜
ã‚»ãƒƒã‚·ãƒ§ãƒ³å†ç”Ÿæˆå‡¦ç†ã¯ã€å¤§å…ƒã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã®ä¸­ã§ã™ã§ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã§ä¸è¦ã§ã™ã€‚

```php:app/Http/Controllers/Auth/LoginController.php
/**
 * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆAPI ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ãƒ¡ã‚½ãƒƒãƒ‰
 *
 * @param Illuminate\Http\Request $request
 * @return \Illuminate\Http\JsonResponse
 */
protected function loggedOut(Request $request)
{
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿæˆã™ã‚‹
    $request->session()->regenerate();

    return response()->json();
}
```

API ã®ãƒ«ãƒ¼ãƒˆã«è¿½åŠ ã€‚

```php:routes/api.php
Route::post('/logout', 'Auth\LoginController@logout')->name('logout');
```

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶å–å¾— API
æ–°ã—ãã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œã£ã¦å®šç¾©ã—ã¾ã™ã€‚
ã“ã® API ã¯èªè¨¼ã‚’ã‹ã‘ãŸã‹ã£ãŸã®ã§ã€auth ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã€‚

```php:app/Http/Controllers/UserController.php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class UserController extends Controller
{
    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
    }

    /**
     * ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶æƒ…å ±å–å¾—
     *
     * @return \App\User|null
     */
    public function show()
    {
        return Auth::user();
    }
}

```

API ã®ãƒ«ãƒ¼ãƒˆã«è¿½åŠ ã€‚

```php:routes/api.php
Route::get('/users/me', 'UserController@show')->name('user');
```

User ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã€‚

```php:app/User.php
/**
 * The attributes that should be visible for arrays.
 *
 * @var array
 */
protected $visible = [
    'name',
];
```
å…ƒã€…ã¯`$hidden`ã§æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã®å ´åˆã¯ React å´ã§ä¸€æ—¦ name ã—ã‹ä½¿ã‚ãªã„ã®ã§ã€`$visible`ã§ name ã®ã¿è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®æ™‚ã«ã€éãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š
å…ƒã€…ã¯`RouteServiceProvider::HOME`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãŸã ã€ãã‚Œã ã¨ HTML ãŒè¿”ã£ã¦ãã¦ã—ã¾ã„ SPA çš„ã«ã¯ä¸éƒ½åˆãªã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶å–å¾— API ã«å¤‰ãˆã¦ãŠãã¾ã™ã€‚

```php:app/Http/Middleware/RedirectIfAuthenticated.php
/**
 * Handle an incoming request.
 *
 * @param  \Illuminate\Http\Request  $request
 * @param  \Closure  $next
 * @param  string|null  $guard
 * @return mixed
 */
public function handle($request, Closure $next, $guard = null)
{
    if (Auth::guard($guard)->check()) {
        return redirect()->route('user');
    }

    return $next($request);
}
```

## SPAï¼ˆReactï¼‰å´
`bootstrap.js`ã¯ç‰¹ã«å¤‰æ›´ã—ã¦ã„ãªã„ã®ã§å‰²æ„›ã€‚

### ã‚¢ãƒ—ãƒªåˆæœŸåŒ– + ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
1ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã§ã‚„ã£ã¦ã‚‹ã®ã§é•·ã„ã§ã™ãŒã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```tsx:resources/ts/app.tsx
import React, { FC } from 'react';
import ReactDOM from 'react-dom';
import {
  BrowserRouter as Router,
  Switch,
  Route,
  Redirect,
} from 'react-router-dom';
import { QueryClient, QueryClientProvider, useQueryClient } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools';
import CssBaseline from '@material-ui/core/CssBaseline';

import Login from './containers/pages/Login';
import Memo from './containers/pages/Memo';
import Loding from './components/pages/Loding';
import { useGetUserQuery, useCurrentUser } from './hooks/user';

/**
 * First we will load all of this project's JavaScript dependencies which
 * includes React and other helpers. It's a great starting point while
 * building robust, powerful web applications using React + Laravel.
 */
require('./bootstrap');

/**
 * Next, we will create a fresh React component instance and attach it to
 * the page. Then, you may begin adding components to this application
 * or customize the JavaScript scaffolding to fit your unique needs.
 */
// require('./components/Example');

const client = new QueryClient();

type Props = {
  exact?: boolean;
  path: string;
  children: React.ReactNode;
};

const UnAuthRoute: FC<Props> = ({ exact = false, path, children }) => {
  const user = useCurrentUser();
  return (
    <Route
      exact={exact}
      path={path}
      render={() => (user ? <Redirect to={{ pathname: '/' }} /> : children)}
    />
  );
};

const AuthRoute: FC<Props> = ({ exact = false, path, children }) => {
  const user = useCurrentUser();
  return (
    <Route
      exact={exact}
      path={path}
      render={({ location }) =>
        user ? (
          children
        ) : (
          <Redirect to={{ pathname: '/login', state: { from: location } }} />
        )
      }
    />
  );
};

const App: FC = () => {
  const queryClient = useQueryClient();
  const { isLoading } = useGetUserQuery({
    retry: 0,
    initialData: undefined,
    onError: () => {
      queryClient.setQueryData('user', null);
    },
  });

  if (isLoading) {
    return <Loding />;
  }

  return (
    <Switch>
      <UnAuthRoute exact path="/login">
        <Login />
      </UnAuthRoute>
      <AuthRoute exact path="/">
        <Memo />
      </AuthRoute>
    </Switch>
  );
};

if (document.getElementById('app')) {
  ReactDOM.render(
    <Router>
      <QueryClientProvider client={client}>
        <CssBaseline />
        <App />
        {process.env.NODE_ENV === 'development' && (
          <ReactQueryDevtools initialIsOpen={false} />
        )}
      </QueryClientProvider>
    </Router>,
    document.getElementById('app')
  );
}
```

#### React Query ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
å†’é ­ã«æ›¸ã„ãŸé€šã‚Šã€ã¾ãš`QueryClient`ã‚’ä½œæˆã€‚
ã‚¢ãƒ—ãƒªã‚’`QueryClientProvider`ã§å›²ã¿ã€ãã“ã«ä½œæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ¸¡ã—ã¾ã™ã€‚

```tsx
const client = new QueryClient();
```

```tsx
if (document.getElementById('app')) {
  ReactDOM.render(
    <Router>
      <QueryClientProvider client={client}>
        <CssBaseline />
        <App />
        {process.env.NODE_ENV === 'development' && (
          <ReactQueryDevtools initialIsOpen={false} />
        )}
      </QueryClientProvider>
    </Router>,
    document.getElementById('app')
  );
}
```

#### ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã®ä¿æŒ
ã¾ãšæœ€åˆã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€æ°¸ç¶šåŒ–ã£ã½ã„ã“ã¨ã‚’ã—ã¦ã„ã¾ã™ã€‚
ã“ã®`useGetUserQuery`ãƒ•ãƒƒã‚¯ã¯`useQuery`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ãŒå–å¾—ã§ããŸæ™‚ã¯ user ã‚­ãƒ¼ã®ä¸­ã¸ã‚»ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ï¼ˆå¾Œè¿°ï¼‰

é€†ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã¯`null`ã‚’ã‚»ãƒƒãƒˆã€‚
ãªãŠã€æœ€åˆã®1å›ã ã‘ã§ã„ã„ã®ã§ã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ã¯0ã«ã€‚

`isLoading`ã‚’å–å¾—ã—ã¦ã€å–å¾—ä¸­ã®æ™‚ã¯ç°¡å˜ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
```tsx
const App: FC = () => {
  const queryClient = useQueryClient();
  const { isLoading } = useGetUserQuery({
    retry: 0,
    initialData: undefined,
    onError: () => {
      queryClient.setQueryData('user', null);
    },
  });

  if (isLoading) {
    return <Loding />;
  }

  return (
    <Switch>
      <UnAuthRoute exact path="/login">
        <Login />
      </UnAuthRoute>
      <AuthRoute exact path="/">
        <Memo />
      </AuthRoute>
    </Switch>
  );
};
```

#### èªè¨¼ãƒ«ãƒ¼ãƒˆã¨éèªè¨¼ãƒ«ãƒ¼ãƒˆ
React Router ãŒæŒã£ã¦ã„ã‚‹`Route`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãã‚Œãã‚Œä½œæˆã€‚
ã“ã®å®Ÿè£…ã¯ React Router å…¬å¼ã®ä¾‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
<OG url="https://v5.reactrouter.com/web/example/auth-workflow" />

`useCurrentUser`ãƒ•ãƒƒã‚¯ã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ã™ï¼ˆå¾Œè¿°ï¼‰
ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã®æœ‰ç„¡ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

èªè¨¼ãƒ«ãƒ¼ãƒˆã®æ–¹ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã« location ã‚’ state ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã®ã¯ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ãŸã‚ã§ã™ã€‚

```tsx
type Props = {
  exact?: boolean;
  path: string;
  children: React.ReactNode;
};

const UnAuthRoute: FC<Props> = ({ exact = false, path, children }) => {
  const user = useCurrentUser();
  return (
    <Route
      exact={exact}
      path={path}
      render={() => (user ? <Redirect to={{ pathname: '/' }} /> : children)}
    />
  );
};

const AuthRoute: FC<Props> = ({ exact = false, path, children }) => {
  const user = useCurrentUser();
  return (
    <Route
      exact={exact}
      path={path}
      render={({ location }) =>
        user ? (
          children
        ) : (
          <Redirect to={{ pathname: '/login', state: { from: location } }} />
        )
      }
    />
  );
};
```

### ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
#### Presentational Component

ç”»é¢ä¸­å¤®ã«ã‚¹ãƒ”ãƒŠãƒ¼ã‚’å‡ºã™ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªç”»é¢ã§ã™ã€‚

```tsx:resources/ts/components/pages/Loding.tsx
import React, { FC } from 'react';
import Box from '@material-ui/core/Box';
import CircularProgress from '@material-ui/core/CircularProgress';
import Container from '@material-ui/core/Container';

const Loding: FC = () => (
  <Container maxWidth="xs">
    <Box
      width={1}
      height="100vh"
      display="flex"
      alignItems="center"
      justifyContent="center"
    >
      <CircularProgress color="inherit" />
    </Box>
  </Container>
);

export default Loding;
```

### ãƒ˜ãƒƒãƒ€ãƒ¼
#### Container Component
`useLogout`ãƒ•ãƒƒã‚¯ã¯`useMutation`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ã™ï¼ˆå¾Œè¿°ï¼‰
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã‚’å—ã‘å–ã‚Šã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®é–¢æ•°ã®ä¸­ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```tsx:resources/ts/containers/organisms/Header.tsx
import React, { FC, useCallback } from 'react';
import { useHistory } from 'react-router-dom';
import Header from '../../components/organisms/Header';
import { useLogout } from '../../hooks/auth';
import { useCurrentUser } from '../../hooks/user';

const EnhancedHeader: FC = () => {
  const user = useCurrentUser();

  const history = useHistory();
  const { mutate } = useLogout();

  const handleLogout = useCallback(() => {
    mutate(undefined, {
      onSuccess: () => {
        history.push('/login');
      },
    });
  }, [history, mutate]);

  return <Header userName={user?.name} handleLogout={handleLogout} />;
};

export default EnhancedHeader;
```

#### Presentational Component
ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶åè¡¨ç¤ºã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’ç½®ãã¨ã„ã†ã¨ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã™ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã‚ã‚Œã¾ã™ãŒã€ä»Šå›ã¯æ¨ªã«ä¸¦ã¹ã¦é…ç½®ã«ã—ã¦ã„ã¾ã™ã€‚

```tsx:resources/ts/components/organisms/Header.tsx
import React, { FC } from 'react';
import AppBar from '@material-ui/core/AppBar';
import Button from '@material-ui/core/Button';
import Toolbar from '@material-ui/core/Toolbar';
import Typography from '@material-ui/core/Typography';
import useTheme from '@material-ui/core/styles/useTheme';

type Props = {
  userName?: string;
  handleLogout: VoidFunction;
};

const Header: FC<Props> = ({ userName, handleLogout }) => {
  const theme = useTheme();
  return (
    <>
      <AppBar
        position="sticky"
        style={{
          color: theme.palette.text.primary,
          backgroundColor: 'white',
        }}
      >
        <Toolbar>
          <Typography
            component="h1"
            variant="h6"
            style={{ flexGrow: 1 }}
            align="center"
          >
            OOUI-MEMO
          </Typography>
          {userName && (
            <>
              <Typography>{userName}</Typography>
              <Button type="button" onClick={handleLogout}>
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </Button>
            </>
          )}
        </Toolbar>
      </AppBar>
    </>
  );
};

export default Header;
```

### ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
#### å®šæ•°
Laravel ã‹ã‚‰è¿”ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å®šæ•°ã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
ã¨ã‚Šã‚ãˆãšã“ã®2ã¤ã ã‘ã€‚

```ts:resources/ts/constants/statusCode.ts
// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
export const UNPROCESSABLE_ENTITY = 422;

// ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼
export const INTERNAL_SERVER_ERROR = 500;
```

#### Presentational Component
ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãŠã„ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã«è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

```tsx:resources/ts/components/molecules/LoginAlert.tsx
import React, { FC } from 'react';
import Alert from '@material-ui/lab/Alert';
import AlertTitle from '@material-ui/lab/AlertTitle';
import {
  UNPROCESSABLE_ENTITY,
  INTERNAL_SERVER_ERROR,
} from '../../constants/statusCode';

type Props = {
  statusCode: number;
};

const LoginAlert: FC<Props> = ({ statusCode }) => (
  <>
    {statusCode === UNPROCESSABLE_ENTITY && (
      <Alert severity="error">
        <AlertTitle>èªè¨¼å¤±æ•—</AlertTitle>
        å…¥åŠ›ã—ãŸæƒ…å ±ã«èª¤ã‚ŠãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚
      </Alert>
    )}
    {statusCode === INTERNAL_SERVER_ERROR && (
      <Alert severity="error">
        <AlertTitle>ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼</AlertTitle>
        äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æã‚Œå…¥ã‚Šã¾ã™ãŒæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
      </Alert>
    )}
  </>
);

export default LoginAlert;
```
ã¡ãªã¿ã«ã“ã†ã„ã†ã‚„ã¤ã§ã™ã€‚
<ImageWrapper class="w-[40%]" src="screenshots/2021/laravel-react-query-auth/login-alert.png" alt="ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºç”»åƒ" />

### ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
#### Container Component
`useLogin`ãƒ•ãƒƒã‚¯ã¯`useMutation`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ã™ï¼ˆå¾Œè¿°ï¼‰
ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã‚’å—ã‘å–ã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®é–¢æ•°ã®ä¸­ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ã™ã‚‹ãŸã‚ã€location.state ã«ã‚»ãƒƒãƒˆã•ã‚ŒãŸã‚‚ã®ãŒã‚ã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãã® URL ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

â€»2021/05/31 è¿½è¨˜
from ã®å‹ã‚’ string ã«ã—ã¦ã—ã¾ã£ã¦ã„ã¾ã™ãŒã€æ­£ã—ãã¯`history`ã®`Location`ã§ã™ã­...ã€‚

```tsx:resources/ts/containers/pages/Login.tsx
import React, { FC, useState, useCallback } from 'react';
import { useHistory, useLocation } from 'react-router-dom';
import Login from '../../components/pages/Login';
import { useLogin } from '../../hooks/auth';

const EnhancedLogin: FC = () => {
  const history = useHistory();
  const location = useLocation();
  const { from } = (location.state as { from: string }) || {
    from: { pathname: '/' },
  };

  const { error, isLoading, mutate } = useLogin();
  const statusCode = error?.response?.status;

  const [email, setEmail] = useState('');
  const [password, serPassword] = useState('');

  const handleChangeEmail = useCallback(
    (ev: React.ChangeEvent<HTMLInputElement>) => {
      setEmail(ev.target.value);
    },
    []
  );

  const handleChangePassword = useCallback(
    (ev: React.ChangeEvent<HTMLInputElement>) => {
      serPassword(ev.target.value);
    },
    []
  );

  const handleLogin = useCallback(
    (ev: React.FormEvent<HTMLFormElement>) => {
      ev.preventDefault();
      if (!email || !password) {
        return;
      }
      mutate(
        { email, password },
        {
          onSuccess: () => {
            history.replace(from);
          },
        }
      );
    },
    [email, password, history, from, mutate]
  );

  return (
    <Login
      email={email}
      password={password}
      handleChangeEmail={handleChangeEmail}
      handleChangePassword={handleChangePassword}
      statusCode={statusCode}
      isLoading={isLoading}
      handleLogin={handleLogin}
    />
  );
};

export default EnhancedLogin;
```

#### Presentational Component
ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œä¸­ã«å†åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€`isLoading`ã‚’ä½¿ã£ã¦ã€å®Ÿè¡Œä¸­ã¯`Backdrop`ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ï¼ˆæš—è»¢ã—ã¦ã‚¹ãƒ”ãƒŠãƒ¼ã‚¯ãƒ«ã‚¯ãƒ«è¡¨ç¤ºã®éƒ¨åˆ†ï¼‰

```tsx:resources/ts/components/pages/Login.tsx
import React, { FC } from 'react';
import Backdrop from '@material-ui/core/Backdrop';
import Box from '@material-ui/core/Box';
import Button from '@material-ui/core/Button';
import CircularProgress from '@material-ui/core/CircularProgress';
import Container from '@material-ui/core/Container';
import Card from '@material-ui/core/Card';
import CardHeader from '@material-ui/core/CardHeader';
import CardContent from '@material-ui/core/CardContent';
import TextField from '@material-ui/core/TextField';
import useTheme from '@material-ui/core/styles/useTheme';
import Header from '../../containers/organisms/Header';
import LoginAlert from '../molecules/LoginAlert';

type Props = {
  email: string;
  password: string;
  handleChangeEmail: (ev: React.ChangeEvent<HTMLInputElement>) => void;
  handleChangePassword: (ev: React.ChangeEvent<HTMLInputElement>) => void;
  statusCode?: number;
  isLoading: boolean;
  handleLogin: (ev: React.FormEvent<HTMLFormElement>) => void;
};

const Login: FC<Props> = ({
  email,
  password,
  handleChangeEmail,
  handleChangePassword,
  statusCode,
  isLoading,
  handleLogin,
}) => {
  const theme = useTheme();
  return (
    <>
      <Header />
      <Container maxWidth="xs">
        <Card style={{ margin: `${theme.spacing(6)}px 0` }}>
          <CardHeader title="login" style={{ textAlign: 'center' }} />
          <CardContent>
            <form onSubmit={handleLogin}>
              <Box
                p={2}
                display="flex"
                flexDirection="column"
                alignItems="center"
              >
                {statusCode && <LoginAlert statusCode={statusCode} />}
                <TextField
                  label="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                  variant="outlined"
                  fullWidth
                  value={email}
                  margin="normal"
                  required
                  autoComplete="email"
                  autoFocus
                  onChange={handleChangeEmail}
                />
                <TextField
                  type="password"
                  label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                  variant="outlined"
                  fullWidth
                  value={password}
                  margin="normal"
                  required
                  autoComplete="current-password"
                  onChange={handleChangePassword}
                />
                <Box my={2}>
                  <Button type="submit" color="primary" variant="contained">
                    ãƒ­ã‚°ã‚¤ãƒ³
                  </Button>
                </Box>
              </Box>
            </form>
          </CardContent>
        </Card>
      </Container>
      <Backdrop style={{ zIndex: theme.zIndex.drawer + 1 }} open={isLoading}>
        <CircularProgress color="inherit" />
      </Backdrop>
    </>
  );
};

export default Login;
```

### ãƒ¡ãƒ¢ï¼ˆã‚¢ãƒ—ãƒªãƒ›ãƒ¼ãƒ ï¼‰ç”»é¢
#### Container Component
ã¾ã æœªå®Ÿè£…ãªã®ã§ç‰¹ã«å‡¦ç†ã¯ãªã„ã§ã™ã€‚

```tsx:resources/ts/containers/pages/Memo.tsx
import React, { FC } from 'react';
import Memo from '../../components/pages/Memo';

const EnhancedMemo: FC = () => <Memo />;

export default EnhancedMemo;
```

#### Presentational Component
ã‚¢ãƒ—ãƒªã®ãƒ›ãƒ¼ãƒ ç”»é¢ã«ãªã‚‹ã‚ã‘ã§ã™ãŒã€ã¾ã æœªå®Ÿè£…ãªã®ã§ã€ã¨ã‚Šã‚ãˆãš Memo ã¨ã ã‘è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```tsx:resources/ts/components/pages/Memo.tsx
import React, { FC } from 'react';
import Box from '@material-ui/core/Box';
import Container from '@material-ui/core/Container';
import Header from '../../containers/organisms/Header';

const Memo: FC = () => (
  <>
    <Header />
    <Container>
      <Box m={4}>Memo</Box>
    </Container>
  </>
);

export default Memo;
```

### User ãƒ¢ãƒ‡ãƒ«å®šç¾©
name ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå‹å®šç¾©ã§ã™ã€‚

```ts:resources/ts/models/User.ts
export type User = {
  name: string;
};
```

### èªè¨¼ã«é–¢ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
#### useLogin
`useMutation`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œã†ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‚
æˆåŠŸæ™‚ã¯ã€è¿”å´ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’ user ã‚­ãƒ¼ã«ã‚»ãƒƒãƒˆã€‚

```ts:resources/ts/hooks/auth/useLogin.ts
import { useQueryClient, UseMutationResult, useMutation } from 'react-query';
import axios, { AxiosError } from 'axios';
import { User } from '../../models/User';

type FormData = {
  email: string;
  password: string;
};

const login = async (formData: FormData): Promise<User> => {
  const { data } = await axios.post('/api/login', formData);
  return data;
};

const useLogin = (): UseMutationResult<
  User,
  AxiosError,
  FormData,
  undefined
> => {
  const queryClient = useQueryClient();

  return useMutation(login, {
    onSuccess: (data) => {
      queryClient.setQueryData('user', data);
    },
  });
};

export default useLogin;
```

#### useLogout
`useMutation`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¡Œã†ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‚
æˆåŠŸæ™‚ã¯ã€user ã‚­ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆã€‚

â€»2021/04/13 è¿½è¨˜
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ä½•ã‚‚è¿”ã•ãªã„å ´åˆã¯ã€logout é–¢æ•°ã§ã‚‚ä½•ã‚‚è¿”ã•ãš void å‹ã«ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã§ã™ã€‚

```ts:resources/ts/hooks/auth/useLogout.ts
import { useQueryClient, UseMutationResult, useMutation } from 'react-query';
import axios, { AxiosError } from 'axios';

const logout = async (): Promise<[]> => {
  const { data } = await axios.post('/api/logout');
  return data;
};

const useLogout = (): UseMutationResult<[], AxiosError, void, undefined> => {
  const queryClient = useQueryClient();

  return useMutation(logout, {
    onSuccess: () => {
      queryClient.resetQueries('user');
    },
  });
};

export default useLogout;
```

#### åå‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
ä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«ã€å†åº¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã¾ã™ã€‚

```ts:resources/ts/hooks/auth/index.ts
export { default as useLogin } from './useLogin';
export { default as useLogout } from './useLogout';
```

### ãƒ¦ãƒ¼ã‚¶ã«é–¢ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
#### useGetUserQuery
`useQuery`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±å–å¾—å‡¦ç†ã‚’è¡Œã†ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‚

â€»2021/04/13 è¿½è¨˜
useGetUserQuery ã®è¿”ã‚Šå€¤ã®å‹ã¯ UseQueryResult ã§ã™ã­...ï¼ˆä¸­èº«çš„ã«ã¯ä¸€ç·’ã ã£ãŸã‚Šã™ã‚‹ã‚“ã§ã™ãŒï¼‰

```ts:resources/ts/hooks/user/useGetUserQuery.ts
import { QueryObserverResult, useQuery, UseQueryOptions } from 'react-query';
import axios, { AxiosError } from 'axios';
import { User } from '../../models/User';

const getLoginUser = async (): Promise<User> => {
  const { data } = await axios.get('/api/users/me');
  return data;
};

const useGetUserQuery = <TData = User>(
  options?: UseQueryOptions<User, AxiosError, TData>
): QueryObserverResult<TData, AxiosError> =>
  useQuery('user', getLoginUser, options);

export default useGetUserQuery;
```

#### useCurrentUser
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‚
ã„ã‚ã‚“ãªã¨ã“ã‚ã§ä½¿ç”¨ã™ã‚‹ã®ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯åŒ–ã—ã¦ã¾ã™ã€‚

```ts:resources/ts/hooks/user/useCurrentUser.ts
import { useQueryClient } from 'react-query';
import { User } from '../../models/User';

// ãƒ­ã‚°ã‚¤ãƒ³ï¼šUser  éãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼šnull  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šundefined
const useCurrentUser = (): User | null | undefined => {
  const queryClient = useQueryClient();
  return queryClient.getQueryData('user');
};

export default useCurrentUser;
```

#### åå‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
ä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«ã€å†åº¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã¾ã™ã€‚
æ”¹è¡Œã—ã¦ã‚‹ã®ã¯ã€ãªã‚“ã¨ãªã API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãã‚Œä»¥å¤–ã¨ã§ã‚ã‹ã‚Šã‚„ã™ãã—ãŸã‹ã£ãŸã®ã§ã€‚

```ts:resources/ts/hooks/auth/index.ts
export { default as useGetUserQuery } from './useGetUserQuery';

export { default as useCurrentUser } from './useCurrentUser';
```

---
ã‚‚ã®ã™ã”ãé•·ããªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯ã“ã‚“ãªæ„Ÿã˜ã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚

ç‰¹ã« React å´ã«é–¢ã—ã¦ã¯ã€ãªã‚‹ã¹ããã‚Œã„ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ã¨ã„ã†æ€ã„ã‚‚ã‚ã‚Šã€[ã‚Šã‚ã‚¯ãƒˆï¼](https://github.com/oukayuka/Riakuto-StartingReact-ja3.1)ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã—ãªãŒã‚‰ã€ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã‚’ã—ã¦ã„ãã¾ã—ãŸã€‚
è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ã‚„ã£ã¦ã„ã£ãŸã®ã§ã€æ™‚é–“ã‚‚ã‹ã‹ã£ã¦ã‚³ãƒŸãƒƒãƒˆæ•°ã‚‚ç„¡é§„ã«å¤šã„ã§ã™ğŸ™„

TypeScript ã«é–¢ã—ã¦ã¯ã€ã¾ã ä½¿ã„å§‹ã‚ãŸã°ã‹ã‚Šãªã®ã§æ…£ã‚Œã¦ãªã„ã®ã§ã™ãŒã€å‹å®šç¾©ãŒãã‚Œã„ã«ãƒãƒã£ãŸæ™‚ã®å…¥åŠ›è£œå®ŒãŒä¾¿åˆ©ã§ã‚„ã°ã„ã§ã™ã­(ç¬‘)
å¼•ãç¶šãå‘ãåˆã£ã¦ã„ãã¾ã™ã€‚

èª²é¡Œã¨ã—ã¦.
- React.Suspense ã‚’ä½¿ã£ã¦å®£è¨€çš„ã«æ›¸ã
- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ãŒåˆ‡ã‚ŒãŸã¨ãã®å¯¾å¿œã‚’ã„ã‚Œã‚‹
- React QUery ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®èª¿æ•´

ã¨ã‹ã€ã¾ã ã§ããã†ãªã“ã¨ã¯ã‚ã‚‹ã®ã§ã€ãã®ã¸ã‚“ã¯ãŠã„ãŠã„ã‚„ã£ã¦ã„ã“ã†ã‹ã¨ãƒ¼ã€‚

ã“ã®å®Ÿè£…ãŒä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯ã¾ã¨ã‚
- [Laravel 6.x](https://readouble.com/laravel/6.x/ja)
- [React Query](https://tanstack.com/query/v3)
- [React Router](https://v5.reactrouter.com)
- [Material UI](https://v4.mui.com)
- [Vue + Vue Router + Vuex + Laravelã§å†™çœŸå…±æœ‰ã‚¢ãƒ—ãƒªã‚’ä½œã‚ã† â€»é€£è¼‰è¨˜äº‹](https://www.hypertextcandy.com/vue-laravel-tutorial-introduction)
- [GitHub - oukayuka/Riakuto-StartingReact-ja3.1 â€»æ›¸ç±](https://github.com/oukayuka/Riakuto-StartingReact-ja3.1)
- [React Queryã‚’ç”¨ã„ãŸé–‹ç™ºäº‹ä¾‹ã®ç´¹ä»‹](https://fintan.jp/?p=5583)
